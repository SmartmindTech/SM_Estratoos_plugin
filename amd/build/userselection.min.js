define(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {

    var users = [];
    var selectedIds = [];
    var strings = {};

    var loadStrings = function() {
        return Str.get_strings([
            {key: 'selectedusers', component: 'local_sm_estratoos_plugin'},
            {key: 'role_student', component: 'local_sm_estratoos_plugin'},
            {key: 'role_teacher', component: 'local_sm_estratoos_plugin'},
            {key: 'role_manager', component: 'local_sm_estratoos_plugin'},
            {key: 'role_other', component: 'local_sm_estratoos_plugin'}
        ]).then(function(strs) {
            strings.selectedusers = strs[0];
            strings.student = strs[1];
            strings.teacher = strs[2];
            strings.manager = strs[3];
            strings.other = strs[4];
            return true;
        });
    };

    var loadUsers = function(companyId, departmentId) {
        var container = $('#user-selection-container');
        var loading = $('#user-list-loading');
        var list = $('#user-list');
        var empty = $('#user-list-empty');

        loading.show();
        list.hide();
        empty.hide();
        container.show();

        users = [];
        selectedIds = [];
        updateSelectedCount();

        Ajax.call([{
            methodname: 'local_sm_estratoos_plugin_get_company_users',
            args: {
                companyid: companyId,
                departmentid: departmentId || 0,
                includeroles: true
            }
        }])[0].done(function(response) {
            loading.hide();

            if (response.users && response.users.length > 0) {
                users = response.users;
                renderUserList();
                list.show();
            } else {
                empty.show();
            }
        }).fail(function(err) {
            loading.hide();
            empty.show();
            Notification.exception(err);
        });
    };

    var renderUserList = function(filter) {
        var list = $('#user-list');
        var html = '<div class="user-items" style="padding: 0.5rem;">';

        filter = filter ? filter.toLowerCase() : '';

        users.forEach(function(user) {
            if (filter) {
                var searchable = (user.fullname + ' ' + user.email).toLowerCase();
                if (searchable.indexOf(filter) === -1) {
                    return;
                }
            }

            var isChecked = selectedIds.indexOf(user.id) !== -1;
            var roleClasses = [];
            var roleBadges = '';
            var userHasManager = false;
            var userHasTeacher = false;
            var userHasStudent = false;
            var userHasOther = false;

            if (user.roles) {
                user.roles.forEach(function(role) {
                    var rolename = role.shortname.toLowerCase();
                    if (rolename.indexOf('manager') !== -1 || rolename.indexOf('admin') !== -1) {
                        userHasManager = true;
                    } else if (rolename.indexOf('teacher') !== -1 ||
                               rolename === 'profesor' || rolename === 'professor') {
                        userHasTeacher = true;
                    } else if (rolename === 'student' || rolename === 'alumno' || rolename === 'estudante') {
                        userHasStudent = true;
                    } else if (rolename !== 'user' && rolename !== 'authenticated' && rolename !== 'guest') {
                        userHasOther = true;
                    }
                });

                if (userHasManager) {
                    roleClasses.push('role-manager');
                    roleBadges += '<span class="badge badge-warning ml-1">' + strings.manager + '</span>';
                } else if (userHasTeacher) {
                    roleClasses.push('role-teacher');
                    roleBadges += '<span class="badge badge-success ml-1">' + strings.teacher + '</span>';
                } else if (userHasOther) {
                    roleClasses.push('role-other');
                    roleBadges += '<span class="badge badge-info ml-1">' + strings.other + '</span>';
                } else if (userHasStudent || user.roles.length === 0) {
                    roleClasses.push('role-student');
                    roleBadges += '<span class="badge badge-primary ml-1">' + strings.student + '</span>';
                }
            }

            html += '<div class="user-item d-flex align-items-center py-2 px-2 border-bottom ' + roleClasses.join(' ') + '" ';
            html += 'style="background: #fff; margin-bottom: 1px;">';
            html += '<div class="custom-control custom-checkbox">';
            html += '<input type="checkbox" class="custom-control-input user-checkbox" ';
            html += 'id="user-' + user.id + '" data-userid="' + user.id + '"';
            if (isChecked) {
                html += ' checked';
            }
            html += '>';
            html += '<label class="custom-control-label" for="user-' + user.id + '" style="cursor: pointer;">';
            html += '<strong>' + user.fullname + '</strong>';
            html += '<small class="text-muted ml-2">' + user.email + '</small>';
            html += roleBadges;
            html += '</label>';
            html += '</div>';
            html += '</div>';
        });

        html += '</div>';
        list.html(html);

        $('.user-checkbox').on('change', function() {
            var userId = parseInt($(this).data('userid'));
            if (this.checked) {
                if (selectedIds.indexOf(userId) === -1) {
                    selectedIds.push(userId);
                }
            } else {
                var idx = selectedIds.indexOf(userId);
                if (idx !== -1) {
                    selectedIds.splice(idx, 1);
                }
            }
            updateSelectedCount();
            updateHiddenField();
        });
    };

    var updateSelectedCount = function() {
        var text = strings.selectedusers.replace('{$a}', selectedIds.length);
        $('#selected-count').text(selectedIds.length + ' ' + text);
    };

    var updateHiddenField = function() {
        $('input[name="selecteduserids"]').val(selectedIds.join(','));
    };

    var selectByRole = function(roleType) {
        selectedIds = [];

        users.forEach(function(user) {
            if (user.roles) {
                var userHasManager = false;
                var userHasTeacher = false;
                var userHasStudent = false;
                var userHasOther = false;

                user.roles.forEach(function(role) {
                    var rolename = role.shortname.toLowerCase();
                    if (rolename.indexOf('manager') !== -1 || rolename.indexOf('admin') !== -1) {
                        userHasManager = true;
                    } else if (rolename.indexOf('teacher') !== -1 ||
                               rolename === 'profesor' || rolename === 'professor') {
                        userHasTeacher = true;
                    } else if (rolename === 'student' || rolename === 'alumno' || rolename === 'estudante') {
                        userHasStudent = true;
                    } else if (rolename !== 'user' && rolename !== 'authenticated' && rolename !== 'guest') {
                        userHasOther = true;
                    }
                });

                var shouldSelect = false;
                if (roleType === 'manager' && userHasManager) {
                    shouldSelect = true;
                } else if (roleType === 'teacher' && userHasTeacher && !userHasManager) {
                    shouldSelect = true;
                } else if (roleType === 'other' && userHasOther && !userHasManager && !userHasTeacher) {
                    shouldSelect = true;
                } else if (roleType === 'student' && !userHasManager && !userHasTeacher && !userHasOther) {
                    shouldSelect = userHasStudent;
                }

                if (shouldSelect) {
                    selectedIds.push(user.id);
                }
            }
        });

        updateCheckboxes();
        updateSelectedCount();
        updateHiddenField();
    };

    var selectAll = function() {
        selectedIds = users.map(function(u) { return u.id; });
        updateCheckboxes();
        updateSelectedCount();
        updateHiddenField();
    };

    var selectNone = function() {
        selectedIds = [];
        updateCheckboxes();
        updateSelectedCount();
        updateHiddenField();
    };

    var updateCheckboxes = function() {
        $('.user-checkbox').each(function() {
            var userId = parseInt($(this).data('userid'));
            $(this).prop('checked', selectedIds.indexOf(userId) !== -1);
        });
    };

    var init = function() {
        loadStrings().then(function() {
            var isIomad = $('input[name="isiomad"]').val() === '1';

            $('#id_companyid').on('change', function() {
                var companyId = parseInt($(this).val());
                var departmentId = parseInt($('#id_departmentid').val()) || 0;

                if (companyId > 0) {
                    loadUsers(companyId, departmentId);
                } else {
                    $('#user-selection-container').hide();
                    users = [];
                    selectedIds = [];
                    updateHiddenField();
                }
            });

            $('#id_departmentid').on('change', function() {
                var companyId = parseInt($('#id_companyid').val());
                var departmentId = parseInt($(this).val()) || 0;

                if (companyId > 0) {
                    loadUsers(companyId, departmentId);
                }
            });

            $('#id_selectionmethod').on('change', function() {
                var method = $(this).val();
                if (method === 'company' || method === 'users') {
                    if (isIomad) {
                        var companyId = parseInt($('#id_companyid').val());
                        if (companyId > 0) {
                            $('#user-selection-container').show();
                        }
                    } else {
                        loadUsers(0, 0);
                    }
                } else {
                    $('#user-selection-container').hide();
                }
            });

            $('#select-all-users').on('click', function(e) {
                e.preventDefault();
                selectAll();
            });

            $('#select-none-users').on('click', function(e) {
                e.preventDefault();
                selectNone();
            });

            $('#select-students').on('click', function(e) {
                e.preventDefault();
                selectByRole('student');
            });

            $('#select-teachers').on('click', function(e) {
                e.preventDefault();
                selectByRole('teacher');
            });

            $('#select-managers').on('click', function(e) {
                e.preventDefault();
                selectByRole('manager');
            });

            $('#select-others').on('click', function(e) {
                e.preventDefault();
                selectByRole('other');
            });

            $(document).on('keyup', '#user-search', function() {
                var filter = $(this).val();
                renderUserList(filter);
            });

            var selectionMethod = $('#id_selectionmethod').val();
            if (isIomad) {
                var initialCompany = parseInt($('#id_companyid').val());
                if (initialCompany > 0 && selectionMethod === 'company') {
                    loadUsers(initialCompany, 0);
                }
            } else {
                if (selectionMethod === 'users') {
                    loadUsers(0, 0);
                }
            }

            return true;
        }).catch(Notification.exception);
    };

    return {
        init: init
    };
});
